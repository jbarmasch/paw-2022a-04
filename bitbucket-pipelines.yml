pipelines:
  branches:
    master:
      - step:
          name: Build and Test
          image: maven:3.6.3-jdk-8
          caches:
            - maven
          script:
            - export webConfigFile="webapp/src/main/java/ar/edu/itba/paw/webapp/config/WebConfig.java"
            - sed -i "s/env.getProperty(\"dbUsername\")/\"$PAW_BOTTLER_USER\"/g" "$webConfigFile"
            - sed -i "s/env.getProperty(\"dbPassword\")/\"$PAW_BOTTLER_PASS\"/g" "$webConfigFile"
            - sed -i "s/env.getProperty(\"dbURL\")/\"jdbc:postgresql:\/\/10.16.1.110\/$PAW_BOTTLER_USER\"/g" "$webConfigFile"
            - sed -i "s/env.getProperty(\"mailUsername\")/\"botpass@zohomail.com\"/g" "$webConfigFile"
            - sed -i "s/env.getProperty(\"mailPassword\")/\"$PAW_BOTTLER_MAILPASS\"/g" "$webConfigFile"
            - mvn clean package
          artifacts:
            - webapp/target/webapp.war
      - step:
          name: Copy files
          deployment: staging
          script:
            - apt-get update && apt-get install -y sshpass
            - ssh-keyscan pampero.itba.edu.ar >> ~/.ssh/known_hosts
            - export SSHPASS="$PAW_BOTTLER_SERPASS"
            - sshpass -e scp webapp/target/webapp.war slococo@pampero.itba.edu.ar:/home/slococo/app.war
      - step:
          name: Deploy
          deployment: production
          trigger: manual
          script:
            - apt-get update && apt-get install -y sshpass
            - ssh-keyscan pampero.itba.edu.ar >> ~/.ssh/known_hosts
            - export SSHPASS="$PAW_BOTTLER_SERPASS"
            - sshpass -e ssh slococo@pampero.itba.edu.ar "./deploy"
 
